---
sidebar: auto
---
# 持续集成

持续集成是一种软件开发实践。通常，开发团队的每个成员每天至少集成一次自己的工作，这意味着每天都会发生多次集成。每次集成都会通过自动化构建（包括编译、发布、自动化测试）来验证，从而尽早地发现集成错误。

研发分支的代码在被集成到主干之前，必须通过一系列的自动化测试验证。如果其中某个环节发生错误，该代码就不能被集成进目标分支。

持续集成虽然不能消除和避免缺陷，但是可以让缺陷提早暴露出来，从而降低修复成本。同时它能避免开发分支和目标分支产生大幅度差异，从而减少分支合并过程中的问题。与持续集成有关的还包括持续交付和持续部署。

## 原则

持续集成的宗旨是避免集成问题，提升软件质量并缩短交付时间。持续集成应遵循以下原则。

* 所有开发人员都需要做本地构建，然后提交到版本控制库中，从而确保变更不会导致持续集成失败。

* 开发人员每天至少向版本控制库提交一次代码。

* 开发人员每天至少需要从版本控制库中更新一次代码到本地机器。

* 有专门的集成服务器执行集成构建，每天执行多次。

* 每次构建都要100%通过。

* 每次构建都可以生成可发布的产品。

* 修复失败的构建是优先级最高的事情。

* 测试是未来，未来是测试。

## 持续交付

持续交付是在持续集成之后的阶段，只有在持续集成通过后才能执行。持续交付是将通过持续集成的代码进行测试，保证当前软件持续保持在随时可以发布的状态。

### 目的

它的目标是让软件的构建、测试与发布变得更快、更频繁，这种方式可以减少软件开发的成本与时间，从而降低风险。

## 持续部署

持续部署是在持续交付之后的阶段，只有在持续交付通过后才能执行。持续部署指通过自动化的手段，将持续交付通过的代码自动地部署到目标环境中。

## 传统工作流程

前端只需要关注持续集成和持续部署。在引入两者之前，前端的研发流程通常如下。

* 在本地进行代码开发和调试工作。

* 在本地运行各种测试脚本。如果测试通过，则进行下一步；如果测试失败，则返回第一步。

* 使用git push将代码提交到远程的代码仓库。

* 进行代码部署。此时，执行npm run build构建项目。如果构建失败，则返回第一步重新执行。

上面4个步骤都需要人力进行保障，每次功能需求研发过程中都会有大量的重复人工操作，增加了时间成本。如果引入持续集成和持续部署对上述流程进行改造，前端开发人员就只需要关注代码的开发和调试工作。

## Jenkins

Jenkins是一个开源软件项目，它是基于Java开发的持续集成工具，用于持续重复的工作。Jenkins旨在提供一个开放易用的软件平台，使软件项目可以持续集成。

### 功能

Jenkins提供了友好的可视化界面，方便开发人员配置各种自定义的任务，完成重复性的工作。Jenkins能实时监控持续集成过程中存在的问题，提供详细的日志文件和提醒功能，以图表来形象地展示项目构建的趋势和稳定性。它可以根据设定的脚本运行相应的代码，例如，运行单元测试或集成测试，将运行结果发送至邮箱或以报告的形式展示等。

### 插件

Jenkins支持插件，这使得它的开源生态圈极其丰富。Jenkins在为开源社区的广大开发人员提供服务时，来自开源社区的反哺也大大增强了它的能力。当发现Jenkins的某项能力缺失时，开发人员可以先通过关键词查询开源社区是否已经有成熟的解决方案。

### 任务简介

Jenkins中所有的操作都是以任务的形式体现的。Jenkins的任务主要分为以下6类。

* 自由风格的项目（FreeStyle Project）：这是Jenkins最主要的功能。Jenkins可以结合任何SCM和任何构建系统来构建项目，甚至可以构建软件以外的系统。

* 流水线（Pipeline）：开发人员可以通过流水线编排长期运行在多个节点上的任务。适用于构建流水线（更加正式地应当称为工作流），或者难以使用自由风格的项目类型进行配置的任务。

* 多配置项目（Muti-configuration Project）：适用于多配置的项目，例如，多环境测试、平台指定构建等。

* 组织文件夹（Organization Folder）：通过扫描仓库创建一组多分支项目子文件夹。

* 多分支流水线（Mutibranch Pipeline）：根据一个SCM仓库中检测到的分支创建一系列流水线。

* 文件夹（Folder）：创建一个可以嵌套存储任务的容器，开发人员可以利用它对任务进行分组。Jenkins允许任务名称同名，只要它们在不同的文件夹里即可。

### 自由风格项目

自由风格的项目不仅是Jenkins最主要的功能，也是使用最广泛的类型，本章仅对这一类型进行讲解。它由6部分组成，分别是基础配置、源码管理、构建触发器、构建环境、构建以及构建后操作。

* 基础配置用于描述任务的基础信息。开发人员可以通过该模块进行配置GitHub的地址、开启构建节流、为构建过程添加自定义参数、配置构建和发布包的保存数量及时间，以及开启并行构建等操作。

* 源码管理用于获取代码仓库。如果开发人员使用Git进行管理，就需要配置对应的仓库地址及身份凭证。身份凭证用于访问私有仓库，开发人员可以选择填写用户名和密码，或选择使用密钥。

* 构建触发器用于描述该任务何时被触发构建。构建触发器有多种触发途径：配置远程脚本触发构建；结合GitLab的Webhook使用，例如当目标仓库触发PushEvents、Opened Merge Request Events、ClosedMerge Request Events等代码更新事件时，Jenkins自动进行任务构建；配置定时器，使用定时任务语法描述构建执行时间，例如，H****代表每小时执行一次任务。以上三种是比较常用的触发途径，更多的方式可以参考配置详情。

* 构建环境用于描述构建运行时的环境情况。构建环境有多个配置项：为构建的输出日志添加时间戳信息，方便日志排查；配置工作空间清理，用于在构建前清理无用的文件；配置任务超时中断，用于处理任务卡死的情况，更多配置项可以参考配置详情。

* 构建用于定义任务构建过程中需要执行的脚本。Jenkins提供了步骤自定义的功能，开发人员可以为任务配置多个步骤并自定义执行顺序。每个步骤都可以自定义需要执行的内容，诸如延时执行、shell命令等。

* 构建后操作用于定义任务构建完成后需要执行的脚本。它的步骤配置形式和构建的配置一致，但是支持的自定义操作步骤更多，例如发送邮件、自动合并构建成功的Pull Request等。

开发人员可以通过使用以上配置项在Jenkins中实现持续集成和持续部署，从而消除重复工作、释放人力、提高工作质量和效率。在一般情况下，package.json的scripts字段中会配置测试相关的脚本命令，开发人员只需要配置好相应的Webhook触发器，在构建环节中添加shell命令执行自定义步骤，运行相应的脚本命令。当开发人员推送代码时，Jenkins就会收到Webhook的通知，然后自动运行相关脚本进行持续集成。

### 配置Webhook

#### GitLab插件

如果开发人员要配置Webhook，那么需要安装三个GitLab插件，分别是GitLab Hook、GitLab及GitLabAuthentication。通过这三个插件，Jenkins可以与GitLab进行交互，响应GitLab中分支的变动情况，从而自动进行持续集成。

#### GitLab Webhook配置

GitLab的Webhook需要在项目设置里进行配置。开发人员填写Jenkins提供的用于事件推送的URL，同时在触发器里勾选需要向Jenkins推送的事件。

#### 小结

完成以上配置后，Jenkins就能通过GitLab监听代码的变更行为了。当代码发生变更时，GitLab会通过Webhook将对应的事件推送到Jenkins。Jenkins会根据构建和构建后操作这两个配置项的自定义步骤来执行相应的任务，从而实现持续集成和持续部署。

## 自动构建

一般来说，项目只有在部署的时候才会进行工程的打包和构建。此前需要经历许多步骤，分别是拉取Git仓库、安装依赖、自定义脚本（如lint检测、单测等）、打包构建、资源上传。资源上传以外的步骤占据了绝大部分时间，这些步骤中的任何一个发生了异常，都会阻断发布流程，需要花费时间进行排查和修复，导致项目的发布滞后。

开发人员可以将资源上传之后的工作全部添加到持续集成里。如果项目以master为基准分支执行发布工作，那么开发人员可以配置相应的Webhook。当基准分支出现内容更新时，Jenkins可以自动拉取Git仓库，同时执行安装依赖、自定义脚本、打包构建等工作，构建相关的问题会在发布前暴露。如果构建成功，那么开发人员可以编写脚本将构建的结果打包成压缩包并使用commit hash命名，然后将该压缩包上传到服务器存储。以下列举几个环节进行自动构建。

* 测试：利用Jest、Cypress甚至LambdaTest。如果执行失败则构建失败，成功后才可进入下一步构建。

* 语法检测：利用Eslint+Prettier检测语法，如果检测成功，则进入下一步。

* 注释扫描：利用fixme扫描一些有关注意事项的的注释，如果扫描的类似TODO这种待处理事项的注释，则会扫描失败，终止构建，提醒开发人员进行修复。扫描成功则进入下一步。

* 依赖检测：利用npm audit命令可以对所有依赖进行风险、漏洞扫描。如果有漏洞情况也可以通过npm audit fix尝试修复。

* 类型检测：利用TypeScript提供的tsc工具可以对静态类型进行检测。如果检测成功，则进行下一步。

* 打包：利用打包工具，比如webpack进行打包，并且将打包文件上传至内部服务器进行存储。以供后续发板。

当项目需要执行时，可以直接根据commit hash到服务器上拉取指定的压缩包进行解压，然后上传资源，快速完成发布流程。不仅节约了大量的发布时间，同时避免了构建过程出错导致的发布滞后。

## 持续部署

持续部署指通过自动化手段将通过持续交付的代码自动部署到目标环境中。在一般情况下，持续部署仅被用于非生产环境。因为自动化的测试手段并不能保证业务逻辑的准确性，所以需要依赖手工测试。

Jenkins有很多种可以实现自动化部署的方式，可以将更新后的代码自动部署到QA的测试环境，有效降低开发人员的操作成本。例如，在Jenkins构建环节中的最后一个步骤中添加shell脚本，将构建好的代码部署到对应的测试环境；也可以新建一个任务，在持续集成任务的“构建后操作”中构建其他工程，并且勾选“只有构建稳定时触发”的选项。

Jenkins的配置非常灵活，自动部署并不局限于以上两种方式，开发人员可以根据实际情况灵活选择。
