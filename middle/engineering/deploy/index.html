<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>系统部署 | 少逸前端文档 ！</title><meta name="description" content="这是markdown文档整理站点">
    <link rel="preload" href="/vuepress/assets/style-1746bcbf.css" as="style"><link rel="stylesheet" href="/vuepress/assets/style-1746bcbf.css">
    <link rel="modulepreload" href="/vuepress/assets/app-a6318679.js"><link rel="modulepreload" href="/vuepress/assets/index.html-8ca5a397.js"><link rel="modulepreload" href="/vuepress/assets/index.html-5c380d86.js"><link rel="prefetch" href="/vuepress/assets/index.html-e50eba57.js" as="script"><link rel="prefetch" href="/vuepress/assets/TaskList.html-5fa9d6d8.js" as="script"><link rel="prefetch" href="/vuepress/assets/css_examples.html-78d10d52.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-380facc4.js" as="script"><link rel="prefetch" href="/vuepress/assets/Markdown语法.html-9f0d4c7b.js" as="script"><link rel="prefetch" href="/vuepress/assets/bookmark.html-0c4d9443.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-e70352af.js" as="script"><link rel="prefetch" href="/vuepress/assets/HTML标签.html-9477ff3c.js" as="script"><link rel="prefetch" href="/vuepress/assets/HTML页面渲染流程.html-a66186d5.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-aa456010.js" as="script"><link rel="prefetch" href="/vuepress/assets/one.html-f74dc7bd.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-8f94ec6c.js" as="script"><link rel="prefetch" href="/vuepress/assets/two.html-6c3077e9.js" as="script"><link rel="prefetch" href="/vuepress/assets/cssDemo1.html-103ea961.js" as="script"><link rel="prefetch" href="/vuepress/assets/css_页面上隐藏元素的方法.html-4f3f1742.js" as="script"><link rel="prefetch" href="/vuepress/assets/bfc块级格式化上下文.html-c6508b5d.js" as="script"><link rel="prefetch" href="/vuepress/assets/三栏布局.html-8b93372b.js" as="script"><link rel="prefetch" href="/vuepress/assets/css_16种方法实现水平居中垂直居中.html-ec12abf0.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-9fc60820.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-f7de46eb.js" as="script"><link rel="prefetch" href="/vuepress/assets/tidbCreateData.html-dc7e7f1f.js" as="script"><link rel="prefetch" href="/vuepress/assets/Flexbox.html-4611a68b.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-879fd31c.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-cb2ab0f5.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-91442bcd.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-8f0f6046.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-6b96aa87.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-b4703dfe.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-aec91714.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-264859e6.js" as="script"><link rel="prefetch" href="/vuepress/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-1983a211.js" as="script"><link rel="prefetch" href="/vuepress/assets/TaskList.html-5f86dbbc.js" as="script"><link rel="prefetch" href="/vuepress/assets/css_examples.html-bd449aad.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-e58e2a39.js" as="script"><link rel="prefetch" href="/vuepress/assets/Markdown语法.html-58b4c5a7.js" as="script"><link rel="prefetch" href="/vuepress/assets/bookmark.html-f3627a31.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-def0523b.js" as="script"><link rel="prefetch" href="/vuepress/assets/HTML标签.html-0b550950.js" as="script"><link rel="prefetch" href="/vuepress/assets/HTML页面渲染流程.html-50da5022.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-469141ba.js" as="script"><link rel="prefetch" href="/vuepress/assets/one.html-f76711d3.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-be74e127.js" as="script"><link rel="prefetch" href="/vuepress/assets/two.html-0ccb09a2.js" as="script"><link rel="prefetch" href="/vuepress/assets/cssDemo1.html-c064bdc7.js" as="script"><link rel="prefetch" href="/vuepress/assets/css_页面上隐藏元素的方法.html-2f738071.js" as="script"><link rel="prefetch" href="/vuepress/assets/bfc块级格式化上下文.html-19750f4d.js" as="script"><link rel="prefetch" href="/vuepress/assets/三栏布局.html-da5d7b21.js" as="script"><link rel="prefetch" href="/vuepress/assets/css_16种方法实现水平居中垂直居中.html-c83eb4cf.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-6bb00cb1.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-5cbfd03b.js" as="script"><link rel="prefetch" href="/vuepress/assets/tidbCreateData.html-2896b955.js" as="script"><link rel="prefetch" href="/vuepress/assets/Flexbox.html-b931a9ca.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-11800b17.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-62d5b780.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-845b73ed.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-ea426bd4.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-40543ffb.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-c3bc5da5.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-5c55f671.js" as="script"><link rel="prefetch" href="/vuepress/assets/index.html-ea4c8b07.js" as="script"><link rel="prefetch" href="/vuepress/assets/404.html-8cb3e215.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vuepress/" class=""><!----><span class="site-name">少逸前端文档 ！</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/vuepress/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/javascript/" class="" aria-label="JAVASCRIPT"><!--[--><!--]--> JAVASCRIPT <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/css/" class="" aria-label="CSS"><!--[--><!--]--> CSS <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/html/" class="" aria-label="HTML"><!--[--><!--]--> HTML <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/helpDoc/bookmark.html" class="" aria-label="其他"><!--[--><!--]--> 其他 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/vuepress/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/javascript/" class="" aria-label="JAVASCRIPT"><!--[--><!--]--> JAVASCRIPT <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/css/" class="" aria-label="CSS"><!--[--><!--]--> CSS <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/html/" class="" aria-label="HTML"><!--[--><!--]--> HTML <!--[--><!--]--></a></div><div class="navbar-item"><a href="/vuepress/helpDoc/bookmark.html" class="" aria-label="其他"><!--[--><!--]--> 其他 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">系统部署 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#前端部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="前端部署"><!--[--><!--]--> 前端部署 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#部署风险" class="router-link-active router-link-exact-active sidebar-item" aria-label="部署风险"><!--[--><!--]--> 部署风险 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#部署平台" class="router-link-active router-link-exact-active sidebar-item" aria-label="部署平台"><!--[--><!--]--> 部署平台 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#传统发布类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="传统发布类型"><!--[--><!--]--> 传统发布类型 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#覆盖式发布" class="router-link-active router-link-exact-active sidebar-item" aria-label="覆盖式发布"><!--[--><!--]--> 覆盖式发布 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#非覆盖式发布" class="router-link-active router-link-exact-active sidebar-item" aria-label="非覆盖式发布"><!--[--><!--]--> 非覆盖式发布 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#灰度发布" class="router-link-active router-link-exact-active sidebar-item" aria-label="灰度发布"><!--[--><!--]--> 灰度发布 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#灰度关键词" class="router-link-active router-link-exact-active sidebar-item" aria-label="灰度关键词"><!--[--><!--]--> 灰度关键词 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#a-b测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="A/B测试"><!--[--><!--]--> A/B测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#硬件隔离" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件隔离"><!--[--><!--]--> 硬件隔离 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#软件隔离" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件隔离"><!--[--><!--]--> 软件隔离 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#放量策略" class="router-link-active router-link-exact-active sidebar-item" aria-label="放量策略"><!--[--><!--]--> 放量策略 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#百分比放量" class="router-link-active router-link-exact-active sidebar-item" aria-label="百分比放量"><!--[--><!--]--> 百分比放量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#名单放量" class="router-link-active router-link-exact-active sidebar-item" aria-label="名单放量"><!--[--><!--]--> 名单放量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#自定义放量" class="router-link-active router-link-exact-active sidebar-item" aria-label="自定义放量"><!--[--><!--]--> 自定义放量 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#发布回滚" class="router-link-active router-link-exact-active sidebar-item" aria-label="发布回滚"><!--[--><!--]--> 发布回滚 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#部署异常" class="router-link-active router-link-exact-active sidebar-item" aria-label="部署异常"><!--[--><!--]--> 部署异常 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vuepress/middle/engineering/deploy/#解决方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="解决方案"><!--[--><!--]--> 解决方案 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="系统部署" tabindex="-1"><a class="header-anchor" href="#系统部署" aria-hidden="true">#</a> 系统部署</h1><p>系统部署指将研发的功能和线上缺陷修复部署到实际生产环境中。</p><h2 id="前端部署" tabindex="-1"><a class="header-anchor" href="#前端部署" aria-hidden="true">#</a> 前端部署</h2><p>前端的系统部署起初是一个非常简单的流程——直接将静态文件提交到服务器即可。随着互联网的发展，企业为了提升用户体验，开始追求交付质量、性能及系统稳定性。例如，为了提升网站性能，把静态资源和动态网页分集群部署，静态资源会被部署到CDN节点上；为了控制新功能上线的影响面，做代码灰度、A/B分流；当新功能上线出现缺陷时，要能够快速进行代码回滚。</p><h2 id="部署风险" tabindex="-1"><a class="header-anchor" href="#部署风险" aria-hidden="true">#</a> 部署风险</h2><p>系统部署是一个复杂过程，整个流程中存在着风险，这是由以下原因造成的：应用软件越来越复杂，包括许多构件、版本和变种；应用发展很快，版本发布的间隔很短（可能只有几个月）；环境的不确定性等。</p><h2 id="部署平台" tabindex="-1"><a class="header-anchor" href="#部署平台" aria-hidden="true">#</a> 部署平台</h2><p>随着系统部署需要考量的方面越来越多，单纯依赖人工进行管理的成本将非常高昂，并且非常容易出错。因此，需要借助平台化的能力来串联发布能力，将发布链路中的各个环节结合起来，由此诞生了部署平台。</p><p>借助部署平台，开发人员可以通过可视化的方式进行一键部署，直接发布任务。在整个发布过程中，平台会将各个环节的运行信息和日志返回。借助部署平台，开发人员在跟踪发布流程和排查发布问题等方面的体验和效率将大大提升。</p><h2 id="传统发布类型" tabindex="-1"><a class="header-anchor" href="#传统发布类型" aria-hidden="true">#</a> 传统发布类型</h2><h3 id="覆盖式发布" tabindex="-1"><a class="header-anchor" href="#覆盖式发布" aria-hidden="true">#</a> 覆盖式发布</h3><p>覆盖式发布指前端将构建好的资源直接上传到目标服务器，覆盖旧的资源。比如使用FTP工具进行服务器单点上传，或者使用shell脚本进行批量上传。早期的页面应用并不复杂，覆盖式发布不仅简单，还能有效节省硬盘空间。在很长一段时间内，覆盖式发布都是前端的主要发布手段。</p><h4 id="缺点" tabindex="-1"><a class="header-anchor" href="#缺点" aria-hidden="true">#</a> 缺点</h4><p>随着页面应用的复杂度和访问量上升，覆盖式发布的问题逐渐暴露。</p><ul><li><p>在上传的过程中，两个文件不可能同时被覆盖，必定存在着先后顺序。从而引起系列问题。</p></li><li><p>当部署的代码出现问题时，服务器上的资源不能直接回滚到上一次的状态，只能代码回滚，重新构建、重新部署。</p></li></ul><h3 id="非覆盖式发布" tabindex="-1"><a class="header-anchor" href="#非覆盖式发布" aria-hidden="true">#</a> 非覆盖式发布</h3><p>非覆盖式发布指前端在将构建好的资源直接上传到目标服务器时，只做增量更新，不会覆盖旧的资源。为了实现这一目标，可以在页面依赖的文件资源名称上添加版本后缀，这样在上传时就不会相互覆盖。非覆盖式发布不会出现新旧文件交替依赖的情况，由此可以有效避免资源上传间隔导致的样式错乱问题。</p><h4 id="缺点-1" tabindex="-1"><a class="header-anchor" href="#缺点-1" aria-hidden="true">#</a> 缺点</h4><ul><li><p>它的缺点是会在服务器上积累大量的无用资源，该问题只需要定时清理即可解决</p></li><li><p>当index.html作为入口页时，不能添加哈希值作为文件后缀，回滚机制并不完善</p></li></ul><h2 id="灰度发布" tabindex="-1"><a class="header-anchor" href="#灰度发布" aria-hidden="true">#</a> 灰度发布</h2><p>灰度发布（又名金丝雀发布）指在黑与白之间平滑过渡的发布方式。它可以让一部分用户继续使用老版本的功能，一部分用户开始尝试使用新版本的功能。</p><p>如果新版本的功能没有出现问题，并且用户对新版本的功能没有什么反对意见，那么可以逐步进行灰度放量，把所有用户都迁移到新版本上。如果出现问题，那么开发人员可以及时进行功能回滚或者灰度缩量，控制影响范围。</p><h3 id="灰度关键词" tabindex="-1"><a class="header-anchor" href="#灰度关键词" aria-hidden="true">#</a> 灰度关键词</h3><p>在详细讲解灰度发布之前，需要了解以下常见关键词。</p><ul><li><p>灰度期：灰度发布从开始到结束的时间被称为灰度期。</p></li><li><p>灰度放量：在灰度期内扩大测试用户范围。</p></li><li><p>灰度缩量：在灰度期内缩小测试用户范围。</p></li><li><p>灰度全量：灰度放量达到100%，即覆盖了所有用户。</p></li><li><p>灰度标识：用于区分当前用户是否在灰度内。</p></li><li><p>灰度用户：带有灰度标识的用户。</p></li><li><p>灰度应用：灰度发布后的新版本应用，即带有灰度标识的用户访问的应用。</p></li><li><p>灰度分流：根据用户的灰度标志来访问不同的版本。</p></li><li><p>放量策略：灰度期间用来分流的判断条件。</p></li><li><p>流量入口：所有请求进入服务端的统一入口，分流一般在这里进行。</p></li><li><p>多灰度并行：生产环境同时有多个灰度版本在运行。</p></li></ul><p>灰度发布可以有效保证整体系统的稳定性。如果本次上线的功能存在隐患，那么在灰度期或许就能发现并修复问题，以控制问题的影响范围。总而言之，灰度发布的本质就是将新旧版本隔离开，降低发布风险。</p><h3 id="a-b测试" tabindex="-1"><a class="header-anchor" href="#a-b测试" aria-hidden="true">#</a> A/B测试</h3><p>A/B测试指在项目工程中利用代码分支的能力控制代码后续的执行逻辑，从而为用户提供不同的页面或功能。</p><h4 id="优缺点" tabindex="-1"><a class="header-anchor" href="#优缺点" aria-hidden="true">#</a> 优缺点</h4><p>A/B测试的优点在于它能够控制的功能粒度是最细的，但是它的缺点也非常明显，就是对代码具有侵入性。A/B测试不仅依赖开发人员在代码中手动埋点，而且在灰度全量后需要删除A/B的代码，同时开发人员需要再进行一次全量发布。A/B测试增长了系统部署的操作链路，而操作链路越长意味着需要做的事情越多，出错的可能性越大。</p><h4 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h4><p>因此，A/B测试并不十分受开发人员喜爱，但产品经理和设计师却非常推崇A/B测试，因为用户体验永远是产品经理和设计师最关心的事情之一。但随意改动已经完善的功能通常是一件很冒险的事情，所以很多产品经理和设计师都会通过收集数据进行决策。一般在保证功能不变的前提下，会针对某一功能设计两个版本进行A/B测试并收集数据，最终选定结果更好的版本。</p><h3 id="硬件隔离" tabindex="-1"><a class="header-anchor" href="#硬件隔离" aria-hidden="true">#</a> 硬件隔离</h3><p>硬件隔离，顾名思义就是从硬件层面上将代码隔离开来。通常来说，就是将新旧功能的代码部署到不同的机器上，直接在物理层面上将其隔离，相互之间不产生影响。</p><h4 id="工作原理" tabindex="-1"><a class="header-anchor" href="#工作原理" aria-hidden="true">#</a> 工作原理</h4><p>当用户访问页面时，会由流量入口对请求进行解析，根据灰度标识确定此次访问应该如何灰度分流。如果目标用户带有灰度标识，则将请求转发到灰度机器上；如果目标用户在不带有灰度标识，则将请求转发到正常机器上。</p><h4 id="成本开销" tabindex="-1"><a class="header-anchor" href="#成本开销" aria-hidden="true">#</a> 成本开销</h4><p>机器分组是最传统的灰度分流手段之一。因为它直接从物理层面进行了隔离，所以能够有效避免一些由环境因素导致的问题。因为机器分组需要额外的机器，所以会带来额外的运维和成本开销。场景分析如下。</p><ul><li><p>使用机器分组进行灰度分流，必须额外配置一台机器。需要先对灰度机器进行环境配置。在非灰度发布期间，如果不释放机器，那么灰度机器将一直处于闲置状态，增加了设备开销；如果释放机器，那么在下次灰度发布时需要再次投入精力重新进行环境配置。</p></li><li><p>假设目前所有的流量仅占用了不到一半的计算资源，但是由于使用机器分组进行灰度分流，所以必须再配置一台机器。在0%至100%的灰度放量期间，两台机器都有至少50%的计算资源是处于闲置状态的。</p></li><li><p>假设目前需要两台服务器才能承载所有流量，则此时必须使用两台灰度机器才能应付灰度放量达到50%以上的情况。理论上，当灰度放量低于50%时，会有一台灰度机器处于闲置状态；当放量等于50%时，正常机器和灰度机器各有一台处于闲置状态；当灰度放量大于50%时，会有一台正常机器处于闲置状态。在整个灰度放量期间，至少有一台机器处于闲置状态。</p></li></ul><h4 id="小结-1" tabindex="-1"><a class="header-anchor" href="#小结-1" aria-hidden="true">#</a> 小结</h4><p>综合以上三种常见的场景分析，可以看出机器分组带来了极大的成本开销。尤其是在多个灰度发布并行时，使用该灰度方案带来的硬件开销将会更大。出于对稳定性等因素的考虑，在实际应用中依然有不少大公司会选择使用机器分组进行灰度分流，相比额外的硬件成本开销，系统的稳定性无疑更加重要。</p><h3 id="软件隔离" tabindex="-1"><a class="header-anchor" href="#软件隔离" aria-hidden="true">#</a> 软件隔离</h3><p>软件隔离指通过技术手段将代码进行隔离，从而进行灰度分流。例如，A/B测试是软件隔离的一种方法。采用软件隔离的灰度分流方案能够在最大程度上利用机器资源、降低运行成本。</p><h4 id="实践方式" tabindex="-1"><a class="header-anchor" href="#实践方式" aria-hidden="true">#</a> 实践方式</h4><p>软件隔离有各种各样的实践方式，以下主要讲解资源隔离和实例隔离两种。</p><ul><li><p>资源隔离：主要用于静态资源的灰度分流，通过文件名称将应用内的资源和应用外的资源进行隔离，其原理类似于非覆盖式发布。该方案仅支持纯前端静态资源的灰度逻辑。</p></li><li><p>实例隔离可用于服务端的灰度分流，通过启动多个应用实例来分别响应灰度内外的请求，这些应用实例可以共享机器的硬件资源。</p></li></ul><h4 id="小结-2" tabindex="-1"><a class="header-anchor" href="#小结-2" aria-hidden="true">#</a> 小结</h4><p>因为共享机器的硬件资源，所以硬件隔离中的三个场景不会额外增加机器的数量。在灰度放量过程中，流量只是从一个实例倾斜到另一个实例或者资源中，因为总流量不变，所以占用的硬件资源不变。</p><p>由于软件隔离没有从物理层面隔离应用，所以可能出现灰度版本影响普通版本的情况。</p><p>软件隔离虽然能有效利用机器资源降低成本，但在稳定性上不如硬件隔离。两者没有绝对的优劣，开发人员应该结合实际情况灵活选择。</p><h2 id="放量策略" tabindex="-1"><a class="header-anchor" href="#放量策略" aria-hidden="true">#</a> 放量策略</h2><h3 id="百分比放量" tabindex="-1"><a class="header-anchor" href="#百分比放量" aria-hidden="true">#</a> 百分比放量</h3><p>百分比放量指按照百分比的形式对用户进行灰度放量，例如，当百分比为10%时，代表仅有10%的用户可以访问灰度版本。它是灰度放量里最简单的策略，也是使用频次最高的策略。通常灰度放量的节奏会以百分比的形式定义，经历0～100%的过程再进行全量发布，接着将灰度放量的数值缩减至0并取消放量策略，就完成了灰度发布的整个流程。</p><h4 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项" aria-hidden="true">#</a> 注意事项</h4><p>百分比放量的定义十分简单，在具体执行时必须确保以下两点。</p><ul><li><p>当百分比不变时必须确定每次命中的灰度用户是一致的。如果不能保证这一点，那么同一用户在访问页面时会出现交替使用新旧版本的情况，引发大量投诉。</p></li><li><p>当百分比调整时必须确定调整前后命中的灰度用户是一致的。例如，当百分比放量从10%调整到30%时，新增的20%灰度用户中有人出现了异常，此时需要缩量回10%，那么必须保证缩量之后的用户和增量之前的用户的覆盖范围一致，即异常用户能够被有效回滚。</p></li></ul><h3 id="名单放量" tabindex="-1"><a class="header-anchor" href="#名单放量" aria-hidden="true">#</a> 名单放量</h3><p>名单放量包括白名单放量和黑名单放量。</p><h4 id="白名单" tabindex="-1"><a class="header-anchor" href="#白名单" aria-hidden="true">#</a> 白名单</h4><p>白名单放量是将名单内的用户加入灰度版本。一般在灰度发布后，会使用白名单放量的形式对部分账号进行线上测试。在某些情况下，也会使用白名单放量让一部分用户抢先体验灰度版本。</p><h4 id="黑名单" tabindex="-1"><a class="header-anchor" href="#黑名单" aria-hidden="true">#</a> 黑名单</h4><p>黑名单放量是对名单内的用户屏蔽灰度版本，常用于过滤百分比放量中需要屏蔽的用户。当用户同时命中多个灰度放量策略时，黑名单放量一般具有最高优先级。对于部分只希望使用稳定版本的用户，通常会将其加入黑名单，不参加灰度放量。只有当新功能经过灰度验证全量发布后，才会触达这部分用户。</p><h4 id="实践方法" tabindex="-1"><a class="header-anchor" href="#实践方法" aria-hidden="true">#</a> 实践方法</h4><p>名单放量的具体方法有两种，一种是枚举放量，一种是区间放量。</p><ul><li><p>枚举放量通过逐个列举的方式，将需要放量的用户名单进行显示声明。如果用户在名单中，就执行对应的逻辑。</p></li><li><p>区间放量是通过区间的形式进行批量配置，有效解决了在用户数量巨大时枚举放量困难的问题。</p></li></ul><h3 id="自定义放量" tabindex="-1"><a class="header-anchor" href="#自定义放量" aria-hidden="true">#</a> 自定义放量</h3><p>自定义放量通常与业务的特性有关，一般由产品经理制定相关的放量策略，由开发人员负责实现。例如，在某个功能模块上线后需要根据用户群体进行放量，诸如用户年龄、性别和地域等信息都可以成为自定义放量的策略选项。</p><h4 id="缺点-2" tabindex="-1"><a class="header-anchor" href="#缺点-2" aria-hidden="true">#</a> 缺点</h4><p>自定义放量更加灵活多变，但是需要开发人员进行编码。如果灰度逻辑处理出现问题，那么不仅会导致灰度分流异常，甚至可能影响正常版本的使用。因此，自定义放量前需要开发人员做好测试和代码评审等质量保障工作。</p><h2 id="发布回滚" tabindex="-1"><a class="header-anchor" href="#发布回滚" aria-hidden="true">#</a> 发布回滚</h2><h3 id="部署异常" tabindex="-1"><a class="header-anchor" href="#部署异常" aria-hidden="true">#</a> 部署异常</h3><p>每次系统部署都存在着引入漏洞的隐患，没有人能保证部署的代码是完美无缺的。当部署的代码出现问题时，开发人员应该立刻进行回滚，先确保生产环境处于正常可用的状态，再去排查产生问题的原因。</p><p>在发布导致生产环境出现问题时，最常用的手段就是发布回滚。当项目体积变大后，代码的构建会非常缓慢。如果采取重新构建的方案进行回滚，那么会浪费大量时间和精力，一旦生产环境出现的问题在等待回滚的过程中进一步扩大了，那么还会收到用户的投诉。</p><h3 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案" aria-hidden="true">#</a> 解决方案</h3><p>发布回滚的方法非常简单。系统每次部署时都会将构建好的资源输出到build目录，开发人员只需使用zip命令将build下面所有的资源进行压缩即可。</p><p>压缩文件可以根据实际情况进行命名，例如，可以选择发布时间、commit hash等信息进行命名。</p><p>当需要进行发布回滚时，直接使用unzip对需要回滚的代码包进行解压。</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: yuzhoufen@foresee.com.cn">yuzhoufen</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/vuepress/assets/app-a6318679.js" defer></script>
  </body>
</html>
